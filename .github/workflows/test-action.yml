name: Build-Test-Deploy

on:
  workflow_dispatch:
    push:
        - master
    schedule:
      - cron: '0 7 * * *'
      - cron: '0 21 * * *'

jobs:
   Build-job:
      runs-on: ubuntu-latest
      name: Making builds
      steps:
        - uses: actions/checkout@v1
        - name: Install surge
          uses: actions/setup-node@v1
          with:
            node-version: 14
        - run: npm install -g surge
   Test-job1:
      runs-on: ubuntu-latest
      name: Test1
      needs: Build-job
      if: github.ref != 'refs/heads/production'
      steps:
        - uses: actions/checkout@v1
        - name: Install surge
          uses: actions/setup-node@v1
          with:
            node-version: 14
        - run: npm install --global mocha
        - run: npm test
   Test-job2:
      runs-on: ubuntu-latest
      name: Test2
      needs: Test-job1
      if: github.ref != 'refs/heads/production'
      steps:
        - uses: actions/checkout@v1
        - name: Install surge
          uses: actions/setup-node@v1
          with:
            node-version: 14
        - run: npm install mocha chai --save-dev
        - run: npm test
   Test-job3:
      runs-on: ubuntu-latest
      name: Test3
      needs: Build-job
      if: github.ref != 'refs/heads/production'
      steps:
        - uses: actions/checkout@v1
        - name: Install surge
          uses: actions/setup-node@v1
          with:
            node-version: 14
        - run: npm install --global mocha
        - run: npm install unit.js
        - run: npm test

     DEploy-job:
       runs-on: ubuntu-latest
       needs: [Test-job1,Test-job2,Test-job3]
       name: DEployment
       steps:
         - uses: actions/checkout@v1
         - name: Install surge
           uses: actions/setup-node@v1
           with:
            node-version: 14
         - run: npm install -g surge
         - run: surge ./ ${{secrets.SURGE_DOMAIN }} --token ${{ secrets.SURGE_TOKEN }}

     Postdeploy-Testing:
    runs-on: ubuntu-latest
    needs: Deploy-job
    name: curl-Testing
    steps:
      - uses: actions/checkout@v1
      - name: curl-Testing
        uses: action/setup-node@v1
        with:
          node-version: 14
      - run: sudo apt install curl
      - run: curl -Is well-to-do-earthquake.surge.sh | head -n 1
